"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[102],{2846:function(e,t,a){a.d(t,{By:function(){return n},u2:function(){return c}});var i,l,n,r,o=a(59297);(i=n||(n={})).WAITING="waiting",i.STARTED="started",i.COMPLETED="ended",(l=r||(r={})).DeserializationError="DeserializationError",l.SerializationError="SerializationError",l.DatabaseError="DatabaseError",l.ImageUploadError="ImageUploadError",l.ImageGenerationError="ImageGenerationError",l.InvalidRequestError="InvalidRequestError",l.AuthenticationError="AuthenticationError",l.NotFoundError="NotFoundError",l.InternalServerError="InternalServerError",l.WebSocketError="WebSocketError";let c=(0,o.createContext)({})},20102:function(e,t,a){a.d(t,{L:function(){return E},C:function(){return k}});var i=a(62284),l=a(66975),n=a(59297),r=a(7722),o=a(15219),c=a(96245),s=a(2846),d=a(1993),p=a(7441);function u(e){return Object.values(e).map(e=>{if("image"===e.panel_type)return{index:e.idx,panel_type:"image",panel_config:{image:e.panel_config.image.id}};if("faceswap"===e.panel_type){let t=e.panel_config;return{index:e.idx,panel_type:"faceswap",panel_config:{faceswap:t.faceswap}}}return"text"===e.panel_type?{index:e.idx,panel_type:"text",meme_text:e.panel_config.text,panel_config:{}}:{index:e.idx,panel_type:e.panel_type,panel_config:{}}})}var f=a(30778),m=a(56845),g=a(96690),_=a(17179),h=a(10469),w=a(81255),y=a(71987),v=a(21317),x=a(25845),b=a(82258);let E=e=>{let{profile:t,socket:a,history:E,deckPageId:k,deckPageRules:S,contest:F,queryParams:A,isMiniStudio:C=!1,children:R}=e,O=(0,c.TL)(),[L]=(0,o.rj)(),[I,{isLoading:W}]=(0,o.ey)(),[j,{isLoading:T}]=(0,o.yo)(),[P]=(0,o.gF)(),{deletePost:D,isDeleting:B}=(0,r.Z)(),[G]=(0,o.KV)(),[H]=(0,o.lR)(),[N]=(0,o.xY)(),[M]=(0,o.GJ)(),[U]=(0,o.Mf)(),[J]=(0,o.ns)(),z=(0,n.useMemo)(()=>(0,w.k)(M,500),[M]),q=(0,n.useMemo)(()=>(0,w.k)(U,500),[U]),[$,K]=(0,n.useState)(null),[V,Q]=(0,n.useState)(null),[Y,X]=(0,n.useState)(null),[Z,ee]=(0,n.useState)(null),[et,ea]=(0,n.useState)(null!=F?F:null),[ei,el]=(0,n.useState)("generate"),[en,er]=(0,n.useState)(s.By.WAITING),[eo,ec]=(0,n.useState)(!1),[es,ed]=(0,n.useState)(!1),[ep,eu]=(0,n.useState)(!1),[ef,em]=(0,n.useState)(!1),[eg,e_]=(0,n.useState)(!1),eh=(0,n.useRef)(!1),{panels:ew,dispatchPanelAction:ey,activePanel:ev,activePanelIdx:ex,setActivePanelIdx:eb,promptValue:eE,isPromptEmpty:ek,isGenerating:eS,isGenerateDisabled:eF,isPostDisabled:eA,selectedLayout:eC,setSelectedLayout:eR}=(0,d.e)(),eO=(0,n.useMemo)(()=>ew[0],[ew]),eL=(0,n.useMemo)(()=>{var e;let t=null!==(e=eO.local.selectedAspectRatio)&&void 0!==e?e:m.t.Square;return(0,h.rf)(eC,t)},[eO.local.selectedAspectRatio,eC]),eI=(0,n.useMemo)(()=>(0,h.vO)(eL.paneWidth,eL.paneHeight),[eL.paneHeight,eL.paneWidth]),eW=(0,n.useMemo)(()=>(0,h.GJ)(eC,eL),[eC,eL]),ej=(0,n.useMemo)(()=>eW.canvasWidth/eW.canvasHeight,[eW]),eT=(0,n.useMemo)(()=>ep||W||es||eo||B||T,[ep,W,es,eo,B,T]),eP=(0,n.useCallback)(e=>{if(K(e),!C){let t=new URL(window.location.href);t.searchParams.set("meme",e.replace("meme:","")),window.history.replaceState({},"",t.toString())}},[C]),eD=(0,n.useCallback)(()=>{let e=localStorage.getItem("selectedAesthetic");e&&ey({action:"update-panel",idx:ex,panel_config:{prompt:{aesthetic:"object"==typeof e?JSON.parse(e).id:e}}});let t=localStorage.getItem("selectedCharacter");t&&ey({action:"update-panel",idx:ex,panel_config:{prompt:{character:"object"==typeof t?JSON.parse(t).id:t}}})},[ex,ey]),eB=(0,n.useCallback)((e,t,a)=>{if(ey({action:"update-panel",idx:e,panel_config:{text:a}}),!$)throw Error("Failed to find composed meme id");return z({meme_id:$,panel_id:t,panel_type:"text",panel_config:{text:a}})},[$,ey,z]),eG=(0,n.useCallback)((e,t,a)=>{var i,l,n,r;if(ey({action:"update-panel",idx:e,panel_config:{text_overlay:{[t]:a}}}),!$)throw Error("Failed to find composed meme id");let o=ew[e];if(!o)throw Error("Failed to find active panel");let c="top_text"===t,s={top_text:a,bottom_text:null!==(n=null===(i=o.panel_config.text_overlay)||void 0===i?void 0:i.bottom_text)&&void 0!==n?n:""},d={top_text:null!==(r=null===(l=o.panel_config.text_overlay)||void 0===l?void 0:l.top_text)&&void 0!==r?r:"",bottom_text:a};q({panel_idx:e,meme_id:$,...{top_text_size:"md",bottom_text_size:"md",additional_config:null,...c?s:d}})},[$,ey,ew,q]),eH=(0,n.useCallback)(async e=>{eP(e.id),e.posts&&e.posts.length>0?X(e.posts[0]):X(null),e.contest?ea(e.contest):ea(null),eR(e.panel_layout);let t=e.panels,a=(0,p.$W)(e.panel_layout);t&&Object.values(t).filter(Boolean).length>0&&(a=(0,p.xe)(t));let i=a[0];eb(0),"text"===i.panel_type?el("text"):"faceswap"===i.panel_type?el("faceswap"):el("generate"),ey({action:"new-project",layout:eC}),Object.values(a).map(e=>{ey({idx:e.idx,id:e.id,action:"update-panel",panel_type:e.panel_type,panel_config:e.panel_config,local:e.local})}),em(!1)},[ey,eC,eb,eP,eR]),eN=(0,n.useCallback)(async e=>{var t,a,i;if(!$)throw Error("Failed to find composed meme id");let{data:l}=await H({meme_id:$,index:ex,image_id:e.id,panel_type:"image",panel_config:{}}),n=null==l?void 0:l[ex],r=null==n?void 0:n.panel_config;if(!n||!r)throw Error("Failed to post meme panel");let o=(0,h.vO)(null!==(t=r.image.width)&&void 0!==t?t:1,null!==(a=r.image.height)&&void 0!==a?a:1),c=null!==(i=r.image.source_url)&&void 0!==i?i:r.image.url;ey({action:"update-panel",idx:ex,panel_type:"image",panel_config:r,local:{src:c,prevSrc:c,selectedAspectRatio:o}})},[ex,$,ey,H]),eM=(0,n.useCallback)(e=>{var t;if(e===ex)return;eb(e);let a=ew[e];if(!a)throw Error("Failed to find active panel");el("image"===(t=a.panel_type)?"generate":t)},[ex,ew,eb]),eU=(0,n.useCallback)(e=>{el(e),ey({action:"update-panel",idx:ex,panel_type:function(e){switch(e){case"library":case"generate":return"image";default:return e}}(e)})},[ex,ey]),eJ=(0,n.useCallback)(async e=>{X(null),eb(0),eu(!0);let t=g.L.One,a=(0,p.$W)(g.L.One);e.panels&&e.panel_layout&&(t=e.panel_layout,a=e.panels);try{let{data:i}=await N({...e.contest_id?{contest_id:e.contest_id}:{},panel_layout:t,panels:u(a)});if(!i)return null;eH(i)}catch(e){throw(0,l.yv)("Failed to remix meme",{variant:"error"}),Error("Failed to init panels server side")}finally{eu(!1)}},[eH,N,eb]),ez=(0,n.useCallback)(async e=>{let{data:t}=await J(e);if(t){ea(t),X(null),eb(0),eu(!0);try{let{data:t}=await N({contest_id:e,panel_layout:g.L.One,panels:u((0,p.$W)(g.L.One))});if(!t)return null;eH(t)}catch(e){(0,l.yv)("Failed to init contest meme",{variant:"error"})}finally{eu(!1)}}},[J,eH,N,eb]),eq=(0,n.useCallback)(async e=>{if(e===eC)return;let t={};if(e===g.L.TwoVertical)t={selectedAspectRatio:m.t.Portrait};else if(e===g.L.TwoHorizontal)t={selectedAspectRatio:m.t.Portrait};else if(e===g.L.Four)t={selectedAspectRatio:m.t.Square};else{let e=null==ev?void 0:ev.local.selectedAspectRatio;t={selectedAspectRatio:null!=e?e:m.t.Square}}let a=f.i4[e],i=(0,p.$W)(e);for(let e in ew)i[e]=ew[e];if(Object.values(i).map(e=>{ey({action:"update-panel",idx:e.idx,panel_type:e.panel_type,panel_config:e.panel_config,local:t})}),eR(e),!$)throw Error("Failed to find composed meme id");G({meme_id:$,panel_layout:e,panels:u(i).slice(0,a)})},[null==ev?void 0:ev.local.selectedAspectRatio,$,ey,ew,eC,eR,G]),e$=(0,n.useCallback)(async e=>{X(null),eu(!0);try{let{data:t}=await N({panel_layout:eC,panels:u((0,p.$W)(eC))});if(!t)throw Error("Failed to init panels server side");let a=t.panels[0];e&&(a={...a,panel_config:{...a.panel_config,prompt:{...a.panel_config.prompt,character:"ai_character:"+e}}});let i={...t.panels,0:a};C||ey({action:"new-project",layout:eC}),Object.values(i).map(e=>{ey({action:"update-panel",idx:e.idx,id:e.id})}),eH({...t,panels:i})}catch(e){}finally{em(!1),eu(!1)}},[ey,C,eH,N,eC]),eK=(0,n.useCallback)(async e=>{var t;if(X(null),ee(null!==(t=null==e?void 0:e.id)&&void 0!==t?t:null),ey({action:"new-project-feed"}),S){let{characters:e,styles:t}=S,a=null==e?void 0:e[0];a&&ey({action:"update-panel",idx:0,panel_config:{prompt:{character:"ai_character:"+a.replace("ai_character:","")}}});let i=null==t?void 0:t[0];i&&ey({action:"update-panel",idx:0,panel_config:{prompt:{aesthetic:"aesthetic:"+i.replace("aesthetic:","")}}})}else e||eD()},[S,ey,eD]),eV=(0,n.useCallback)(async e=>{if(eh.current)return;eh.current=!0;let{remixMemeId:t,memeId:a,characterId:i,contestId:l}=A,n=async t=>{let a;let i=e.find(e=>e.id.replace("meme:","")===t);if(i)a=i;else{let{data:e}=await L(t);a=e}if(!a)throw Error("Failed to find matching meme for query param");return a},r=async()=>eH(e[0]);try{if(t){let e=await n(t);await eJ(e)}else if(l)await ez(l);else if(a){let e=await n(a);await eH(e)}else i?await e$(i):e.length>0?await r():await e$()}catch(e){await r()}let o=new URL(window.location.href);o.searchParams.delete("remix"),o.searchParams.delete("contestId"),o.searchParams.delete("character"),window.history.replaceState({},"",o.toString())},[L,eH,e$,ez,eJ,A]),eQ=(0,n.useCallback)(e=>{let t=e.findIndex(e=>e.id===$);return -1===t?e[0]:t>0?e[t-1]:t<e.length-1?e[t+1]:e[0]},[$]),eY=(0,n.useCallback)(async()=>{if($&&E)try{let e=1===E.length;if(await I($),e)e$();else{let e=eQ(E);eH(e)}}catch(e){(0,l.yv)("Failed to delete meme",{variant:"error"})}},[$,I,eQ,E,eH,e$]),eX=(0,n.useCallback)(async()=>{if(Y)try{await D({postId:Y}),X(null),ee(null)}catch(e){(0,l.yv)("Failed to delete post",{variant:"error"})}},[D,Y]),eZ=(0,n.useCallback)(async(e,t)=>{ey({action:"new-project",layout:e});try{ed(!0);let{data:a}=await N({panel_layout:e,panels:u(t),contest_id:null==et?void 0:et.id});if(!a)throw Error("Failed to init panels server side");eH(a),X(null)}catch(e){(0,l.yv)("Failed to duplicate post",{variant:"error"})}finally{ed(!1)}},[null==et?void 0:et.id,ey,eH,N]),e0=(0,n.useCallback)((e,t,i,l)=>{var n;if(!a)return;if(!$)throw Error("Failed to find composed meme id");let r={faceswap_strength:ew[e].panel_config.faceswap.faceswap_strength,face_image:t,base_image:i,base_width:l.width,base_height:l.height,panel_idx:e,meme_id:$};ey({idx:e,action:"update-panel",panel_type:"faceswap",panel_config:{prompt:{seed:0},text:""},local:{prevSrc:null===(n=ew[e])||void 0===n?void 0:n.local.src,src:void 0,isGenerating:!0}}),a.send(JSON.stringify({kind:"generate_faceswap",data:r}))},[$,ey,ew,a]),e1=(0,n.useCallback)((e,i)=>{var l;let n;if(!a)return;let r=i.panel_config.prompt;if(!r)throw Error("Failed to find prompt");let o="fixed"===r.seed_type?r.seed:(0,v.qb)(),c=null===(l=r.character)||void 0===l?void 0:l.replace("ai_character:",""),d=r.aesthetic;try{d=JSON.parse(d||"error").id}catch(e){}let p=et&&"active"===et.status,u=p?et.id:void 0;C&&k&&(n=[k]),C&&!k&&(n=["feed"]);let m={meme_id:C?null:$,panel_idx:C?null:e,contest_id:C&&p?u:void 0,allowed_to_auto_post:!p,post_to_deck_ids:n,workflow:"flux_dev_v2",do_prompt_expansion:i.local.isExpandedPrompt,user_id:t.id,positive_prompt:eE,negative_prompt:r.user_negative_prompt,seed:o,aspect_ratio:eC!==g.L.One?f.aN[eC]:i.local.selectedAspectRatio,character:r.character?{id:c,strength_model:1}:null,steps:20,aesthetic:d,cfg_scale:r.cfg_scale};ey({idx:e,action:"update-panel",panel_type:"image",panel_config:{image:{width:eL.paneWidth,height:eL.paneHeight},prompt:{seed:o},text:"",faceswap:{face_image:void 0,base_image:void 0,faceswap_strength:.5}},local:{isGenerating:!0,src:void 0,prevSrc:i.local.src}}),er(s.By.WAITING),a.send(JSON.stringify({kind:"flux_generate_image",data:m}))},[$,et,k,ey,C,eL.paneHeight,eL.paneWidth,t.id,eE,eC,er,a]),e2=(0,n.useCallback)(e=>{ey({idx:ex,action:"update-panel",panel_config:{prompt:{user_positive_prompt:e}}})},[ex,ey]),e8=(0,n.useCallback)(async(e,t,a)=>{try{ec(!0);let i=[];if(a&&"string"==typeof a){let e=a.split(",")[1];i=(0,v.RG)(e)}else{let t=await (0,_.jt)(e,eC,(0,h.vO)(eL.paneWidth,eL.paneHeight));i=Array.from(new Uint8Array(t))}let{data:l}=await P({meme_id:t,bytes:i,deck_ids:["deck:feed"]});if(!l||!l.meme)throw Error("Failed to post meme");X(l.id),ee(l.id),K(l.meme.id),Q((0,b.LA)(l.meme)),e_(!0)}catch(e){}finally{ec(!1)}},[eL.paneHeight,eL.paneWidth,P,eC]),e9=(0,n.useCallback)(async e=>{if(!$)throw Error("Failed to post composed meme");e8(ew,$,e)},[$,ew,e8]),e7=(0,n.useCallback)(async()=>{if(!et)throw Error("Failed to find contest");if(!$)throw Error("Failed to post composed meme");try{ec(!0);let e=await (0,_.jt)(ew,eC,(0,h.vO)(eL.paneWidth,eL.paneHeight)),{data:t}=await P({meme_id:$,bytes:Array.from(new Uint8Array(e)),deck_ids:[et.deck_id],contest_id:et.id,allowed_to_auto_post:!1});if(!t||!t.meme)throw Error("Failed to post composed meme");X(t.id),ee(t.id),K(t.meme.id),Q((0,b.LA)(t.meme))}catch(e){}finally{ec(!1)}},[$,et,eL.paneHeight,eL.paneWidth,ew,P,eC]),e4=(0,n.useCallback)(async()=>{if(!et)throw Error("Failed to find contest");if(!Y)throw Error("Failed to post composed meme");try{await j({contestId:et.id,entryId:Y}),X(null),ee(null)}catch(e){}},[et,j,Y]);return(0,n.useEffect)(()=>{a&&(a.onmessage=e=>{let t=Object.values(ew).find(e=>e.local.isGenerating);if(t){if(y.BB,"started"===(e=JSON.parse(e.data)).status&&er(s.By.STARTED),"faceswap_generated"===e.type){let a=new Blob([new Uint8Array(e.data)],{type:"image/jpeg"}),i=new FileReader;i.onloadend=()=>{let a=i.result;ey({idx:t.idx,action:"update-panel",panel_type:"faceswap",panel_config:{image:{width:e.dimensions[0],height:e.dimensions[1]},faceswap:{base_width:e.dimensions[0],base_height:e.dimensions[1]}},local:{selectedAspectRatio:(0,h.vO)(e.dimensions[0],e.dimensions[1]),src:a,progress:100,isGenerating:!1}})},i.readAsDataURL(a)}else if("image_generating"===e.kind){let a=new Blob([new Uint8Array(e.data)],{type:"image/jpeg"}),i=new FileReader;i.onloadend=()=>{let a=i.result;ey({idx:t.idx,action:"update-panel",local:{src:a,progress:e.progress}}),C&&100===e.progress&&(ec(!0),Q(a))},i.readAsDataURL(a)}else if("image_created"===e.type&&C){let t=e.post;if(!t)throw Error("Failed to find post");let a={...t,is_creator:!0};O(o.vK.util.updateQueryData("getPosts",{deck_id:"feed"},e=>e?[a,...e]:[a])),k&&(a.meme&&(a={...a,meme:{...a.meme,contest:null!=et?et:void 0}}),O(o.vK.util.updateQueryData("getPostsSearch",{deck_id:(0,x.eC)(k)},e=>{e&&(e.memes=[a,...e.memes])}))),O(o.vK.util.updateQueryData("getDecksNewPosts",void 0,e=>{t.appears_in.map(e=>e.id).forEach(t=>{let a=e[t];a&&(e[t]=a+1)})})),ec(!1),eK(t)}else if("image_generated"===e.kind||"meme_created"===e.type){let a=new Blob([new Uint8Array(e.data)],{type:"image/jpeg"}),i=new FileReader;i.onloadend=async()=>{let a=e.id,l=i.result;if(!t)throw Error("Failed to find active panel");ey({idx:t.idx,action:"update-panel",panel_type:"image",panel_config:{image:{id:a}},local:{src:l,prevSrc:l,progress:100,isGenerating:!1}})},i.readAsDataURL(a)}else"same_prompt"===e.kind&&ey({idx:t.idx,action:"update-panel",local:{src:t.local.prevSrc,progress:100,isGenerating:!1}})}})},[k,O,C,eK,ew,a,er,ey,F,et]),(0,n.useEffect)(()=>{C?eK():E&&eV(E)},[E,C,eK,eV]),(0,i.jsx)(s.u2.Provider,{value:{panels:ew,activePanel:ev,activePanelIdx:ex,activeJobStatus:en,selectedTab:ei,selectedLayout:eC,promptValue:eE,isPromptEmpty:ek,onChangePromptValue:e2,postId:Y,previousPostId:Z,composedMemeId:$,rawSrc:V,contest:et,isPostDisabled:eA,isPosting:eo,isGenerating:eS,isUnpublishing:B,isDeletingMeme:W,isDuplicating:es,isCreatingProject:ep,isPostModalOpen:eg,isSidebarMenuOpen:ef,isGenerateDisabled:eF,isDoingSomething:eT,canvasDimensions:eW,canvasAspectRatio:ej,paneDimensions:eL,paneAspectRatio:eI,toggleIsSidebarMenuOpen:()=>em(e=>!e),onChangeTextPanel:eB,onChangeTextOverlay:eG,onClosePostModal:()=>e_(!1),onClickHistory:eH,onClickLibrary:eN,onClickPane:eM,onClickTab:eU,onSelectPanelLayout:eq,onClickNewProject:e$,onClickDelete:eY,onClickUnpublish:eX,onClickDuplicateProject:eZ,onClickGenerate:e1,onClickFaceswap:e0,onClickPublish:e9,onClickSubmitToContest:e7,onClickUnsubmitFromContest:e4,dispatchPanelAction:ey},children:R})},k=()=>{let e=(0,n.useContext)(s.u2);if(void 0===e)throw Error("useStudio must be used within StudioProvider");return e}},17179:function(e,t,a){a.d(t,{jt:function(){return h},el:function(){return m},mr:function(){return _}});var i=a(30778),l=a(96690);async function n(e){return await new Promise((t,a)=>{e.toBlob(e=>{if(!e){a(Error("Failed to create blob"));return}let i=new FileReader;i.onload=()=>{t(new Uint8Array(i.result))},i.readAsArrayBuffer(e)},"image/jpeg")})}var r=a(10469),o=a(99378);async function c(e){let{ctx:t,url:a,x:i,y:l,paneWidth:n,paneHeight:r}=e,c=new Image;c.crossOrigin="Anonymous",c.src=a,await new Promise((e,t)=>{c.onload=e,c.onerror=t}),await (0,o.h)({ctx:t,image:c,targetWidth:n,targetHeight:r,imageWidth:c.width,imageHeight:c.height,anchorX:i,anchorY:l})}var s=a(71987);async function d(e){let{ctx:t,content:a,placement:i,x:l,y:n,maxWidth:r}=e;return new Promise(e=>{for(var o=a.split(" "),c="",d=[],p=0;p<o.length;p++){var u=c+o[p]+" ";t.measureText(u).width>r&&p>0?(d.push({text:c,y:n}),c=o[p]+" ",n+=100):c=u}if(d.push({text:c.trim(),y:n}),"bottom"===i){let e=100*d.length;d=d.map(t=>({text:t.text,y:t.y-e+100}))}if("center"===i){let e=100*d.length;d=d.map(t=>({text:t.text,y:t.y-e/2+50}))}d.forEach(e=>{(0,s.Dt)()?(t.strokeText(e.text,l,e.y),t.fillText(e.text,l,e.y)):(t.fillText(e.text,l,e.y),t.strokeText(e.text,l,e.y))}),e()})}let p="bold ".concat(80,"px Impact");function u(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];e.font=p,e.fillStyle=t?"white":"black",e.strokeStyle=t?"black":"white",e.lineWidth=3,e.lineJoin="round",e.textAlign="center",(0,s.Dt)()&&(e.shadowColor=t?"black":"white",e.shadowBlur=6,e.shadowOffsetX=0,e.shadowOffsetY=0)}var f=a(82258);async function m(e){let{image:t,canvas:a,topText:i,bottomText:l,centerText:n,canvasWidth:r,canvasHeight:c,imageWidth:s,imageHeight:p}=e,f=a.getContext("2d");if(!f||(t.width=s,t.height=p,a.width=r,a.height=c,n?(f.fillStyle="white",f.fillRect(0,0,a.width,a.height)):await (0,o.h)({ctx:f,image:t,targetWidth:r,targetHeight:c,imageWidth:s,imageHeight:p}),!i&&!l&&!n))return;u(f,!n);let m=a.width-40,g=a.width/2,_=a.height/2,h=a.height-64;i&&await d({ctx:f,content:i,placement:"top",x:g,y:120,maxWidth:m}),n&&await d({ctx:f,content:n,placement:"center",x:g,y:_,maxWidth:m}),l&&await d({ctx:f,content:l,placement:"bottom",x:g,y:h,maxWidth:m})}async function g(e,t,a,i,l){return new Promise(n=>{e.fillStyle="black",e.fillRect(t,a,i,l),n()})}async function _(e){let{canvas:t,studioPanels:a,studioLayout:n,paneAspectRatio:o}=e,s=t.getContext("2d");if(!s)throw Error("Failed to create canvas context");let{paneWidth:p,paneHeight:m}=(0,r.rf)(n,o),_=(0,r.rf)(n,o),{canvasWidth:h,canvasHeight:w}=(0,r.GJ)(n,_);t.width=h,t.height=w;let y=Object.values(a),v=y.map(e=>"image"===e.panel_type||"faceswap"===e.panel_type?e:null).filter(Boolean),x=y.map(e=>"text"===e.panel_type?e:null).filter(Boolean);for(let e=0;e<Math.min(i.i4[n],v.length+x.length);e++){let t=v.find(t=>(null==t?void 0:t.idx)===e),a=x.find(t=>(null==t?void 0:t.idx)===e);if(!t&&!a)continue;let i=0,r=0;if(n===l.L.TwoHorizontal?(i=e%2==0?0:p,r=0):n===l.L.TwoVertical?(i=0,r=e%2==0?0:m):n===l.L.Four&&(i=e%2==0?0:p,r=e<2?0:m),t)try{var b,E;let e=(0,f.LA)(null==t?void 0:t.panel_config.image);"local"in t&&(e=t.local.src),await c({ctx:s,url:e,x:i,y:r,paneWidth:p,paneHeight:m}),u(s);let a=null===(b=t.panel_config.text_overlay)||void 0===b?void 0:b.top_text,l=null===(E=t.panel_config.text_overlay)||void 0===E?void 0:E.bottom_text,n=p-40,o=i+p/2,g=r+120,_=r+m-64;a&&await d({ctx:s,content:a,placement:"top",x:o,y:g,maxWidth:n}),l&&await d({ctx:s,content:l,placement:"bottom",x:o,y:_,maxWidth:n})}catch(e){}else if(a){s.fillStyle="white",s.fillRect(i,r,p,m),u(s,!1);let e=p-40,t=i+p/2,l=r+m/2;await d({ctx:s,content:a.panel_config.text,placement:"center",x:t,y:l,maxWidth:e})}}n===l.L.TwoHorizontal?await g(s,p,0,10,w):n===l.L.TwoVertical?await g(s,0,m,h,10):n===l.L.Four&&(await g(s,p,0,10,w),await g(s,0,m,h,10))}async function h(e,t,a){let i=document.createElement("canvas");return await _({canvas:i,studioPanels:e,studioLayout:t,paneAspectRatio:a}),n(i)}}}]);