"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2526],{9899:function(e,t,a){a.d(t,{Z:function(){return l}});var i=a(7590),n=a(62247);let l=e=>{let{isOpen:t=!0,children:a,onClick:l}=e;return(0,i.jsx)("div",{className:(0,n.cn)("modal-overlay","fixed inset-0 z-50 flex size-full max-h-full min-h-0 items-start xs:items-center justify-center overflow-y-auto overflow-x-hidden","bg-white-100 px-4 py-[10vh]","transition-opacity duration-100",{"opacity-0":!t,"opacity-100":t,"pointer-events-none":!t}),onClick:l,children:a})}},56597:function(e,t,a){a.d(t,{B:function(){return r}});var i=a(7590),n=a(27613),l=a(22566),o=a(62247);let r=e=>{let{keepMemeDeck:t=!1,keepStudio:a=!1}=e;return(0,i.jsxs)("div",{className:"flex items-center h-8 min-h-8",children:[(0,i.jsx)(n.default,{priority:!0,src:l.Z,alt:"Meme Deck",className:(0,o.cn)("h-8 w-auto xl:block",t?"":"hidden"),draggable:!1}),(0,i.jsx)("h1",{className:(0,o.cn)("text-stone-300 text-lg sm:block",a?"":"hidden"),children:"Studio"})]})}},33358:function(e,t,a){a.d(t,{a:function(){return g}});var i=a(7590),n=a(77848),l=a(40774),o=a(9769),r=a(81662),c=a(10015),s=a(73109),d=a(34239),p=a(62247);let u={[s.B.WAITING]:"Waiting in queue...",[s.B.STARTED]:"Running...",[s.B.COMPLETED]:"Completed"},f=e=>{let{index:t}=e,{activeJobStatus:a,panels:n,contest:o}=(0,d.C)(),s=n[t];if(!s)return null;let{src:f}=s.local;return(0,i.jsx)(l.E.div,{className:"absolute bottom-10 w-full flex items-center justify-center",initial:{opacity:0,scale:.85},animate:{opacity:f?0:1,scale:f?.9:1,transition:{duration:.3}},exit:{opacity:0,scale:.9},children:(0,i.jsx)(r.w,{shadow:"none",className:(0,p.cn)("h-12 w-48 text-sm mx-3 flex flex-row justify-center items-center gap-2 p-2 rounded-xl border-2",o?"border-violet-400":"border-orange-400"),children:(0,i.jsx)(c.M,{mode:"wait",children:(0,i.jsx)(l.E.h2,{className:(0,p.cn)("truncate select-none",o?"text-violet-400":"text-orange-400"),initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},transition:{duration:.2},children:u[a]},a)})})})};var m=a(16275);let g=e=>{var t;let{index:a,hideborder:r=!1}=e,{activePanelIdx:c,panels:s,selectedLayout:u,paneDimensions:g,contest:_,onClickPane:h}=(0,d.C)(),v=s[a],y=c===a;if(!v)return console.error("Panel not found for index",a),null;let{src:w,progress:x,isGenerating:b}=v.local,A=v.panel_config.image,{top_text:k,bottom_text:S}=null!==(t=v.panel_config.text_overlay)&&void 0!==t?t:{},j=m.WN[u];return(0,i.jsxs)("div",{style:{aspectRatio:g.paneWidth/g.paneHeight},className:(0,p.cn)(j,"relative flex-1 overflow-hidden mx-auto my-0 bg-black-400",r?"border-none":"border-3",y?_?"border-violet-400":"border-orange-400":"border-transparent"),onClick:()=>h(a),children:[b&&!w&&(0,i.jsx)(l.E.div,{className:"size-full flex items-center justify-center backdrop-blur-lg",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:(0,i.jsx)(n.X,{className:"size-full opacity-50"})}),b&&(0,i.jsx)(f,{index:a}),(0,i.jsx)(l.E.div,{className:"size-full max-h-full flex items-center justify-center",initial:{opacity:0},animate:{opacity:1},children:(0,i.jsx)(o.g,{type:v.panel_type,src:w||A.source_url,topText:null!=k?k:"",progress:b?x:100,bottomText:null!=S?S:"",centerText:v.panel_config.text,imageWidth:A.width,imageHeight:A.height,canvasWidth:g.paneWidth,canvasHeight:g.paneHeight},w)})]})}},64405:function(e,t,a){a.d(t,{Z:function(){return r}});var i=a(7590),n=a(82581),l=a(18095),o=a(34239);let r=e=>{var t;let{isMobile:a=!1,isSmall:r=!1}=e,{activePanel:c,activePanelIdx:s,dispatchPanelAction:d}=(0,o.C)(),p=null==c?void 0:null===(t=c.panel_config.prompt)||void 0===t?void 0:t.aesthetic,u=(0,n.useCallback)(e=>{var t,a;d({idx:s,action:"update-panel",panel_config:{prompt:{aesthetic:null!==(t=null==e?void 0:e.id)&&void 0!==t?t:null}}}),localStorage.setItem("selectedAesthetic",null!==(a=null==e?void 0:e.id)&&void 0!==a?a:"")},[s,d]);return(0,i.jsx)(l.d,{aestheticId:p,onSelect:u,isMobile:a,isSmall:r,hideDescription:r,isDisabled:!c})}},79604:function(e,t,a){a.d(t,{U:function(){return r}});var i=a(7590),n=a(82581),l=a(49682),o=a(34239);let r=e=>{var t,a;let{isSmall:r=!1}=e,{activePanel:c,activePanelIdx:s,dispatchPanelAction:d}=(0,o.C)(),p=(0,n.useCallback)(e=>{e&&(d({idx:s,action:"update-panel",panel_config:{prompt:{character:e.id}}}),localStorage.setItem("selectedCharacter",e.id))},[s,d]);return(0,i.jsx)(l.z,{characterId:null!==(a=null==c?void 0:null===(t=c.panel_config.prompt)||void 0===t?void 0:t.character)&&void 0!==a?a:"",onSelect:p,showClearButton:!1,isSmall:r,isDisabled:!c})}},41245:function(e,t,a){a.d(t,{s:function(){return f}});var i=a(7590),n=a(15866),l=a(72655),o=a(82581),r=a(92782);let c=()=>r.cm?"wss://staging-generation-api.memedeck.xyz/v2/ws":r.BB||r.j7?"wss://studio.api.memedeck.xyz/v2/ws":"ws://127.0.0.1:8079/v2/ws";var s=a(3333),d=a(32701);let p=()=>(0,i.jsxs)("div",{className:"flex items-center gap-3",children:[(0,i.jsx)(n.c,{size:"sm",color:"white"}),"Connecting to server"]}),u=(0,d.D)(()=>{(0,l.yv)((0,i.jsx)(p,{}),{key:"reconnect",variant:"warning",hideIconVariant:!0,preventDuplicate:!0,persist:!0})},1e3),f=e=>{let{showToast:t=!1}=e,{data:a}=(0,s.iS)(),[i,n]=(0,o.useState)(null),r=(0,o.useRef)(!1),d=(0,o.useCallback)(()=>{if(!a)return;let e=new WebSocket("".concat(c(),"/").concat(a.id));return e.onopen=()=>{console.log("Connected to server"),(0,l.sy)()},e.onclose=()=>{!0!==r.current&&(console.warn("Disconnected from server"),setTimeout(()=>{d()},2e3),t&&u())},n(e),e},[a,t]);return(0,o.useEffect)(()=>{let e=d();return r.current=!1,()=>{e&&e.close(),r.current=!0,(0,l.sy)()}},[d]),{socket:i}}},85183:function(e,t,a){a.d(t,{CG:function(){return l},TL:function(){return n}});var i=a(24580);let n=i.I0.withTypes(),l=i.v9.withTypes();i.oR.withTypes()},73109:function(e,t,a){a.d(t,{B:function(){return n},u:function(){return o}});var i,n,l=a(82581);(i=n||(n={})).WAITING="waiting",i.STARTED="started",i.COMPLETED="ended";let o=(0,l.createContext)({})},34239:function(e,t,a){a.d(t,{L:function(){return y},C:function(){return w}});var i=a(7590),n=a(72655),l=a(82581),o=a(3333),r=a(85183),c=a(8413);let s=(e,t)=>{switch(t.action){case"new-project":return(0,c.$W)(t.layout);case"update-panel":{var a,i,n,l,o,r,s,d;let{idx:p,...u}=t,f=e[p];f||(console.warn("Panel not found, creating default panel"),f=(0,c.jt)(p));let m=null!==(r=u.panel_type)&&void 0!==r?r:f.panel_type,g={idx:p,in:f.in,id:null!==(s=u.id)&&void 0!==s?s:f.id,panel_type:m,panel_config:{image:{...f.panel_config.image,...null===(a=u.panel_config)||void 0===a?void 0:a.image},prompt:{...f.panel_config.prompt,...null===(i=u.panel_config)||void 0===i?void 0:i.prompt},text_overlay:{...f.panel_config.text_overlay,...null===(n=u.panel_config)||void 0===n?void 0:n.text_overlay},text:null!==(d=null===(l=u.panel_config)||void 0===l?void 0:l.text)&&void 0!==d?d:f.panel_config.text,faceswap:{...f.panel_config.faceswap,...null===(o=u.panel_config)||void 0===o?void 0:o.faceswap}},local:{...f.local,...u.local}};return{...e,[p]:g}}default:return console.error("Unknown action type"),e}};var d=a(73109);function p(e){return Object.values(e).map(e=>{if("image"===e.panel_type)return{index:e.idx,panel_type:"image",panel_config:{image:e.panel_config.image.id}};if("faceswap"===e.panel_type){let t=e.panel_config;return{index:e.idx,panel_type:"faceswap",panel_config:{faceswap:t.faceswap}}}return"text"===e.panel_type?{index:e.idx,panel_type:"text",meme_text:e.panel_config.text,panel_config:{}}:{index:e.idx,panel_type:e.panel_type,panel_config:{}}})}var u=a(16275),f=a(97032),m=a(79738),g=a(89065),_=a(22890),h=a(32701),v=a(7922);let y=e=>{let{profile:t,socket:a,config:y,history:w,queryParams:x,isGeneratingFromFeed:b,children:A}=e,k=(0,r.TL)(),[S]=(0,o.rj)(),[j,{isLoading:E}]=(0,o.ey)(),[C]=(0,o.yo)(),[R]=(0,o.gF)(),[F]=(0,o.jn)(),[O]=(0,o.KV)(),[W]=(0,o.lR)(),[N]=(0,o.xY)(),[L]=(0,o.GJ)(),[T]=(0,o.Mf)(),[I]=(0,o.ns)(),M=(0,l.useMemo)(()=>(0,h.k)(L,500),[L]),P=(0,l.useMemo)(()=>(0,h.k)(T,500),[T]),[B,G]=(0,l.useState)(null),[D,U]=(0,l.useState)(null),[z,H]=(0,l.useState)(null),[J,q]=(0,l.useState)(null),[V,Z]=(0,l.useState)(0),[$,K]=(0,l.useState)(d.B.WAITING),[Q,X]=(0,l.useState)("generate"),[Y,ee]=(0,l.useState)(m.L.One),[et,ea]=(0,l.useState)(!1),[ei,en]=(0,l.useState)(!1),[el,eo]=(0,l.useState)(!1),[er,ec]=(0,l.useState)(!1),[es,ed]=(0,l.useState)(!1),[ep,eu]=(0,l.useState)(!1),ef=(0,l.useRef)(!1),[em,eg]=(0,l.useReducer)(s,(0,c.$W)(Y)),e_=(0,l.useMemo)(()=>em[0],[em]),eh=(0,l.useMemo)(()=>em[V],[em,V]),ev=(0,l.useMemo)(()=>{var e;let t=null!==(e=e_.local.selectedAspectRatio)&&void 0!==e?e:f.t.Square;return(0,_.rf)(Y,t)},[e_.local.selectedAspectRatio,Y]),ey=(0,l.useMemo)(()=>(0,_.vO)(ev.paneWidth,ev.paneHeight),[ev.paneHeight,ev.paneWidth]),ew=(0,l.useMemo)(()=>(0,_.GJ)(Y,ev),[Y,ev]),ex=(0,l.useMemo)(()=>ew.canvasWidth/ew.canvasHeight,[ew]),eb=(0,l.useMemo)(()=>Object.values(em).slice(0,u.i4[Y]).some(e=>"text"===e.panel_type?""===e.panel_config.text:"image"!==e.panel_type&&"faceswap"!==e.panel_type||""===e.local.src||e.local.isGenerating),[em,Y]),eA=(0,l.useMemo)(()=>Object.values(em).some(e=>e.local.isGenerating),[em]),ek=(0,l.useCallback)(e=>{if(G(e),!b){let t=new URL(window.location.href);t.searchParams.set("meme",e.replace("meme:","")),window.history.replaceState({},"",t.toString())}},[b]),eS=(0,l.useCallback)(()=>{let e=localStorage.getItem("isExpandedPrompt");e&&eg({action:"update-panel",idx:V,local:{isExpandedPrompt:JSON.parse(e)}});let t=localStorage.getItem("selectedAesthetic");t&&eg({action:"update-panel",idx:V,panel_config:{prompt:{aesthetic:"object"==typeof t?JSON.parse(t).id:t}}});let a=localStorage.getItem("selectedCharacter");a&&eg({action:"update-panel",idx:V,panel_config:{prompt:{character:"object"==typeof a?JSON.parse(a).id:a}}})},[V]),ej=(0,l.useCallback)((e,t,a)=>{if(eg({action:"update-panel",idx:e,panel_config:{text:a}}),!B)throw Error("Failed to find composed meme id");return M({meme_id:B,panel_id:t,panel_type:"text",panel_config:{text:a}})},[B,M]),eE=(0,l.useCallback)((e,t,a)=>{var i,n,l,o;if(eg({action:"update-panel",idx:e,panel_config:{text_overlay:{[t]:a}}}),!B)throw Error("Failed to find composed meme id");let r=em[e];if(!r)throw Error("Failed to find active panel");let c="top_text"===t,s={top_text:a,bottom_text:null!==(l=null===(i=r.panel_config.text_overlay)||void 0===i?void 0:i.bottom_text)&&void 0!==l?l:""},d={top_text:null!==(o=null===(n=r.panel_config.text_overlay)||void 0===n?void 0:n.top_text)&&void 0!==o?o:"",bottom_text:a};P({panel_idx:e,meme_id:B,...{top_text_size:"md",bottom_text_size:"md",additional_config:null,...c?s:d}})},[B,em,P]),eC=(0,l.useCallback)(async e=>{ek(e.id),e.posts&&e.posts.length>0?H(e.posts[0]):H(null),e.contest?q(e.contest):q(null),ee(e.panel_layout);let t=e.panels,a=(0,c.$W)(e.panel_layout);t&&Object.values(t).filter(Boolean).length>0?a=(0,c.xe)(t):console.log("Empty project, loading in default panels");let i=a[0];Z(0),"text"===i.panel_type?X("text"):"faceswap"===i.panel_type?X("faceswap"):X("generate"),eg({action:"new-project",layout:Y}),Object.values(a).map(e=>{eg({idx:e.idx,id:e.id,action:"update-panel",panel_type:e.panel_type,panel_config:e.panel_config,local:e.local})}),ed(!1)},[Y,ek]),eR=(0,l.useCallback)(async e=>{var t,a,i;if(!B)throw Error("Failed to find composed meme id");let{data:n}=await W({meme_id:B,index:V,image_id:e.id,panel_type:"image",panel_config:{}}),l=null==n?void 0:n[0],o=null==l?void 0:l.panel_config;if(!l||!o)throw Error("Failed to post meme panel");let r=(0,_.vO)(null!==(t=o.image.width)&&void 0!==t?t:1,null!==(a=o.image.height)&&void 0!==a?a:1),c=null!==(i=o.image.source_url)&&void 0!==i?i:o.image.url;eg({action:"update-panel",idx:V,panel_type:"image",panel_config:o,local:{src:c,prevSrc:c,selectedAspectRatio:r}})},[V,B,W]),eF=(0,l.useCallback)(e=>{var t;if(e===V)return;Z(e);let a=em[e];if(!a)throw Error("Failed to find active panel");X("image"===(t=a.panel_type)?"generate":t)},[V,em]),eO=(0,l.useCallback)(e=>{X(e),eg({action:"update-panel",idx:V,panel_type:function(e){switch(e){case"library":case"generate":return"image";default:return e}}(e)})},[V]),eW=(0,l.useCallback)(async e=>{H(null),Z(0),ec(!0);let t=m.L.One,a=(0,c.$W)(m.L.One);e.panels&&e.panel_layout&&(t=e.panel_layout,a=e.panels);try{let{data:i}=await N({...e.contest_id?{contest_id:e.contest_id}:{},panel_layout:t,panels:p(a)});if(!i)return null;eC(i);let n=new URL(window.location.href);n.searchParams.delete("remix"),window.history.replaceState({},"",n.toString())}catch(e){throw(0,n.yv)("Failed to remix meme",{variant:"error"}),Error("Failed to init panels server side")}finally{ec(!1)}},[eC,N]),eN=(0,l.useCallback)(async e=>{let{data:t}=await I(e);if(t){q(t),H(null),Z(0),ec(!0);try{let{data:t}=await N({contest_id:e,panel_layout:m.L.One,panels:p((0,c.$W)(m.L.One))});if(!t)return null;eC(t);let a=new URL(window.location.href);a.searchParams.delete("contestId"),window.history.replaceState({},"",a.toString())}catch(e){(0,n.yv)("Failed to init contest meme",{variant:"error"})}finally{ec(!1)}}},[I,eC,N]),eL=(0,l.useCallback)(async e=>{if(e===Y)return;let t={};if(e===m.L.TwoVertical)t={selectedAspectRatio:f.t.Portrait};else if(e===m.L.TwoHorizontal)t={selectedAspectRatio:f.t.Portrait};else if(e===m.L.Four)t={selectedAspectRatio:f.t.Square};else{let e=null==eh?void 0:eh.local.selectedAspectRatio;t={selectedAspectRatio:null!=e?e:f.t.Square}}let a=u.i4[e],i=(0,c.$W)(e);for(let e in em)i[e]=em[e];if(Object.values(i).map(e=>{eg({action:"update-panel",idx:e.idx,panel_type:e.panel_type,panel_config:e.panel_config,local:t})}),ee(e),!B)throw Error("Failed to find composed meme id");O({meme_id:B,panel_layout:e,panels:p(i).slice(0,a)})},[null==eh?void 0:eh.local.selectedAspectRatio,B,em,Y,O]),eT=(0,l.useCallback)(async(e,t)=>{ec(!0);try{let{data:a}=await N({panel_layout:Y,panels:p((0,c.$W)(Y))});if(!a)throw Error("Failed to init panels server side");let i=null==a?void 0:a.panels;if(e&&"string"==typeof e){let t=i[0].panel_config.prompt;t&&(t.character=e)}if(t&&"string"==typeof t){let e=i[0].panel_config.prompt;e&&(e.aesthetic=t)}b||eg({action:"new-project",layout:Y}),Object.values(i).map(a=>{eg({action:"update-panel",idx:a.idx,id:a.id,panel_config:{prompt:{character:e,aesthetic:t}}})}),eC(a)}catch(e){console.error("Failed to create new project",e)}finally{ed(!1),ec(!1)}},[b,eC,N,Y]),eI=(0,l.useCallback)(async e=>{var t,a;H(null),eg({action:"new-project",layout:Y}),(null==e?void 0:null===(t=e.image)||void 0===t?void 0:t.prompt)&&eg({action:"update-panel",idx:0,panel_config:{prompt:null==e?void 0:null===(a=e.image)||void 0===a?void 0:a.prompt}})},[Y]),eM=(0,l.useCallback)(async e=>{let t=y.characters.find(t=>t.id===e);if(t)console.log("Found character",t);else throw Error("Failed to find character");eg({action:"update-panel",idx:0,panel_config:{prompt:{character:e}}}),await eT(e);let a=new URL(window.location.href);a.searchParams.delete("character"),window.history.replaceState({},"",a.toString())},[y.characters,eT]),eP=(0,l.useCallback)(async e=>{if(ef.current)return;ef.current=!0;let{remixMemeId:t,memeId:a,characterId:i,contestId:n}=x,l=async t=>{let a;let i=e.find(e=>e.id.replace("meme:","")===t);if(i)a=i;else{let{data:e}=await S(t);a=e}if(!a)throw Error("Failed to find matching meme for query param");return a},o=async()=>{e[0]?await eC(e[0]):await eT()};try{if(t){let e=await l(t);eW(e)}else if(n)eN(n);else if(a){let e=await l(a);eC(e)}else b?eI():o()}catch(e){console.error(e),o()}i&&eM(i)},[S,b,eC,eT,eI,eM,eN,eW,x]),eB=(0,l.useCallback)(e=>{let t=e.findIndex(e=>e.id===B);return -1===t?e[0]:t>0?e[t-1]:t<e.length-1?e[t+1]:e[0]},[B]),eG=(0,l.useCallback)(async()=>{if(B)try{let e=1===w.length;if(await j(B),e)eT();else{let e=eB(w);eC(e)}}catch(e){(0,n.yv)("Failed to delete meme",{variant:"error"})}},[B,j,eB,w,eC,eT]),eD=(0,l.useCallback)(async()=>{if(z)try{en(!0),await F(z),H(null)}catch(e){(0,n.yv)("Failed to delete post",{variant:"error"})}finally{en(!1)}},[F,z]),eU=(0,l.useCallback)(async(e,t)=>{let a=u.i4[e];try{eo(!0),eg({action:"new-project",layout:e}),Object.values(t).slice(0,a).map(e=>{var t;eg({action:"update-panel",...e,panel_type:e.panel_type,panel_config:e.panel_config,local:{...null!==(t=e.local)&&void 0!==t?t:{},isGenerating:!1}})});let{data:i}=await N({panel_layout:e,panels:p(t),contest_id:null==J?void 0:J.id});if(!i)throw Error("Failed to init panels server side");eC(i),H(null)}catch(e){(0,n.yv)("Failed to duplicate post",{variant:"error"})}finally{eo(!1)}},[null==J?void 0:J.id,eC,N]),ez=(0,l.useCallback)((e,t,i,n)=>{var l;if(!a)return;if(!B)throw Error("Failed to find composed meme id");let o={kind:"generate_faceswap",data:{faceswap_strength:em[e].panel_config.faceswap.faceswap_strength,face_image:t,base_image:i,base_width:n.width,base_height:n.height,panel_idx:e,meme_id:B}};console.log("Generating faceswap",o),eg({idx:e,action:"update-panel",panel_type:"faceswap",panel_config:{prompt:{seed:0},text:""},local:{prevSrc:null===(l=em[e])||void 0===l?void 0:l.local.src,src:void 0,isGenerating:!0}}),a.send(JSON.stringify(o))},[B,em,a]),eH=(0,l.useCallback)((e,i)=>{var n;if(!a)return;let l=i.panel_config.prompt;if(!l)throw Error("Failed to find prompt");let o="fixed"===l.seed_type?l.seed:(0,v.qb)(),r=null===(n=l.character)||void 0===n?void 0:n.replace("ai_character:",""),c=l.aesthetic;try{c=JSON.parse(c||"error").id}catch(e){}let s={meme_id:b?null:B,panel_idx:b?null:e,contest_id:null==J?void 0:J.id,allowed_to_auto_post:!J,post_to_deck_ids:b?["feed"]:void 0,workflow:"combined",quality:"fast",do_prompt_expansion:i.local.isExpandedPrompt,user_id:t.id,positive_prompt:l.user_positive_prompt,negative_prompt:l.user_negative_prompt,seed:o,aspect_ratio:Y!==m.L.One?u.aN[Y]:i.local.selectedAspectRatio,character:l.character?{id:r,strength_model:1}:null,styler:{id:"photorealistic",strength_model:1},aesthetic:c,cfg_scale:l.cfg_scale};eg({idx:e,action:"update-panel",panel_type:"image",panel_config:{image:{width:ev.paneWidth,height:ev.paneHeight},prompt:{seed:o},text:"",faceswap:{face_image:void 0,base_image:void 0,faceswap_strength:1}},local:{isGenerating:!0,src:void 0,prevSrc:i.local.src}}),K(d.B.WAITING);let p={kind:"generate_image",data:s};console.log("sending payload",p),a.send(JSON.stringify(p))},[B,J,b,ev.paneHeight,ev.paneWidth,t.id,Y,a]),eJ=(0,l.useCallback)(async(e,t,a)=>{try{ea(!0);let i=[];if(a&&"string"==typeof a){let e=a.split(",")[1];i=(0,v.RG)(e)}else{let t=await (0,g.jt)(e,Y,(0,_.vO)(ev.paneWidth,ev.paneHeight));i=Array.from(new Uint8Array(t))}let{data:n}=await R({meme_id:t,bytes:i,deck_ids:["deck:feed"]});if(!n||!n.meme)throw Error("Failed to post meme");H(n.id),U(n.meme.url),eu(!0)}catch(e){console.error("Failed to compile composed meme",e)}finally{ea(!1)}},[ev.paneHeight,ev.paneWidth,R,Y]),eq=(0,l.useCallback)(()=>{Object.values(em).forEach(e=>{eg({action:"update-panel",idx:e.idx,local:{progress:0,isGenerating:!1}})})},[em]),eV=(0,l.useCallback)(async e=>{if(!B)throw Error("Failed to post composed meme");eJ(em,B,e)},[B,em,eJ]),eZ=(0,l.useCallback)(async()=>{if(!J)throw Error("Failed to find contest");if(!B)throw Error("Failed to post composed meme");try{ea(!0);let e=await (0,g.jt)(em,Y,(0,_.vO)(ev.paneWidth,ev.paneHeight)),{data:t}=await R({meme_id:B,bytes:Array.from(new Uint8Array(e)),deck_ids:["deck:feed"]});if(!t||!t.meme)throw Error("Failed to post composed meme");H(t.id),U(t.meme.url)}catch(e){console.error("Failed to compile composed meme",e)}finally{ea(!1)}},[B,J,ev.paneHeight,ev.paneWidth,em,R,Y]),e$=(0,l.useCallback)(async()=>{if(!J)throw Error("Failed to find contest");if(!z)throw Error("Failed to post composed meme");try{ea(!0),await C({contestId:J.id,entryId:z}),H(null)}catch(e){console.error("Failed to compile composed meme",e)}finally{ea(!1)}},[J,C,z]);return(0,l.useEffect)(()=>{a&&(a.onmessage=e=>{let t=Object.values(em).find(e=>e.local.isGenerating);if(!t){console.error("Failed to find generating panel");return}if(console.log("Socket message",JSON.parse(e.data)),"started"===(e=JSON.parse(e.data)).status&&K(d.B.STARTED),"faceswap_generated"===e.type){console.log("Faceswap generated",e);let a=new Blob([new Uint8Array(e.data)],{type:"image/jpeg"}),i=new FileReader;i.onloadend=()=>{let a=i.result;eg({idx:t.idx,action:"update-panel",panel_type:"faceswap",panel_config:{image:{width:e.dimensions[0],height:e.dimensions[1]},faceswap:{base_width:e.dimensions[0],base_height:e.dimensions[1]}},local:{selectedAspectRatio:(0,_.vO)(e.dimensions[0],e.dimensions[1]),src:a,progress:100,isGenerating:!1}})},i.readAsDataURL(a)}else if("image_generating"===e.kind){let a=new Blob([new Uint8Array(e.data)],{type:"image/jpeg"}),i=new FileReader;i.onloadend=()=>{let a=i.result;eg({idx:t.idx,action:"update-panel",local:{src:a,progress:e.progress}})},i.readAsDataURL(a)}else if("image_created"===e.type&&b){let t=e.post;if(!t)throw Error("Failed to find post");let a={...t,is_creator:!0};k(o.vK.util.updateQueryData("getPosts",{deck_id:"feed"},e=>e?[a,...e]:[a])),k(o.vK.util.updateQueryData("getDecksNewPosts",void 0,e=>{t.appears_in.map(e=>e.id).forEach(t=>{let a=e[t];a&&(e[t]=a+1)})})),eI(t)}else if("image_generated"===e.kind||"meme_created"===e.type){let a=new Blob([new Uint8Array(e.data)],{type:"image/jpeg"}),i=new FileReader;i.onloadend=async()=>{let a=e.id,n=i.result;if(!t)throw Error("Failed to find active panel");eg({idx:t.idx,action:"update-panel",panel_type:"image",panel_config:{image:{id:a}},local:{src:n,prevSrc:n,progress:100,isGenerating:!1}})},i.readAsDataURL(a)}else"same_prompt"===e.kind&&eg({idx:t.idx,action:"update-panel",local:{src:t.local.prevSrc,progress:100,isGenerating:!1}})})},[k,b,eI,em,a]),(0,l.useEffect)(()=>{eS()},[eS]),(0,l.useEffect)(()=>{w&&eP(w)},[w,eP]),(0,i.jsx)(d.u.Provider,{value:{panels:em,activePanel:eh,activePanelIdx:V,activeJobStatus:$,selectedTab:Q,selectedLayout:Y,postId:z,composedMemeId:B,composedMemeUrl:D,contest:J,isPostDisabled:eb,isPosting:et,isUnpublishing:ei,isDeleting:E,isDuplicating:el,isCreatingProject:er,isPostModalOpen:ep,isSidebarMenuOpen:es,isGenerateDisabled:eA,canvasDimensions:ew,canvasAspectRatio:ex,paneDimensions:ev,paneAspectRatio:ey,toggleIsSidebarMenuOpen:()=>ed(e=>!e),onChangeTextPanel:ej,onChangeTextOverlay:eE,onClosePostModal:()=>eu(!1),onClickHistory:eC,onClickLibrary:eR,onClickPane:eF,onClickTab:eO,onSelectPanelLayout:eL,onClickNewProject:eT,onClickDelete:eG,onClickUnpublish:eD,onClickDuplicateProject:eU,onClickGenerate:eH,onClickFaceswap:ez,onClickPublish:eV,onClickCancelPublish:eq,onClickSubmitToContest:eZ,onClickUnsubmitFromContest:e$,dispatchPanelAction:eg},children:A})},w=()=>{let e=(0,l.useContext)(d.u);if(void 0===e)throw Error("useStudio must be used within StudioProvider");return e}},8413:function(e,t,a){a.d(t,{$W:function(){return u},jt:function(){return p},xe:function(){return f}});var i=a(16275),n=a(97032),l=a(79738),o=a(22890);let r={id:"",by:{},caption:"",extracted_text:"",filename:"",filetype:"",height:1152,width:1152,source:"generated",source_url:"",url:"",prompt:null,is_nsfw:!1,created_at:"",updated_at:""},c={aspect_ratio:n.t.Square,cfg_scale:2.7,character:"ai_character:pepe",id:"image_prompt:default",negative_prompt:"",positive_prompt:"",quality:"fast",seed:378254695419,styler:"ai_image_style:photorealistic",user_negative_prompt:"",user_positive_prompt:"",workflow:"workflow:combined",additional_config:{},aesthetic:null,seed_type:"random",user:"",start_ts:"",end_ts:""},s={top_text:"",bottom_text:"",top_text_size:"md",bottom_text_size:"md",additional_config:null,by:"",created_at:0,updated_at:0},d={panel_idx:0,meme_id:"",base_height:1152,base_image:"",base_width:1152,face_image:"",faceswap_strength:.5};function p(e){return{idx:e,id:e.toString(),in:"",panel_type:"image",panel_config:{image:r,prompt:c,text:"",text_overlay:s,faceswap:d},local:{src:"",prevSrc:"",selectedAspectRatio:n.t.Square,isExpandedPrompt:!1,progress:0,isGenerating:!1}}}function u(e){let t=i.i4[e],a={};for(let e=0;e<t;e++){let t=p(e);a[t.idx]=t}return a}function f(e){let t=u(l.L.One);return Object.values(e).reduce((e,a)=>{let i=a.panel_config.image,l="",r=n.t.Square;return i&&(l=i.source_url&&i.source_url.length>0?i.source_url:i.url,r=(0,o.vO)(i.width,i.height)),e[a.idx]={id:a.id,idx:a.idx,in:a.in,panel_type:a.panel_type,panel_config:{...t[0].panel_config,...a.panel_config},local:{selectedAspectRatio:r,isExpandedPrompt:!1,progress:0,src:l,prevSrc:l,isGenerating:!1}},e},{})}},7922:function(e,t,a){function i(){return Math.floor(1e12*Math.random())}function n(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function l(e){let t=atob(e),a=t.length,i=new Uint8Array(new ArrayBuffer(a));for(let e=0;e<a;e++)i[e]=t.charCodeAt(e);return Array.from(i)}a.d(t,{RG:function(){return l},pw:function(){return n},qb:function(){return i}})},62300:function(e,t){t.Z={src:"/memedeck:memedeck:meme-deck.os/_next/static/media/search.3dc28276.svg",height:18,width:18,blurWidth:0,blurHeight:0}},12173:function(e,t){t.Z={src:"/memedeck:memedeck:meme-deck.os/_next/static/media/x.493d8304.png",height:45,width:41,blurDataURL:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAcAAAAICAMAAAAC2hU0AAAALVBMVEVMaXH+/v79/f3+/v79/f38/Pz8/Pz8/Pz9/f39/f39/f36+vr4+Pj9/f38/PwKLxeaAAAAD3RSTlMAS48j05o6aYO9pxgSs1uR71/vAAAACXBIWXMAABYlAAAWJQFJUiTwAAAANElEQVR4nBXBiRHAIAwEsT0/2AbSf7sZJJYcfNGR94SgzaYAt9w89pmAmso8KJyezXK40g8cqQDpZl1e6QAAAABJRU5ErkJggg==",blurWidth:7,blurHeight:8}},22566:function(e,t){t.Z={src:"/memedeck:memedeck:meme-deck.os/_next/static/media/logo-wide.572ec4d3.svg",height:256,width:702,blurWidth:0,blurHeight:0}}}]);